<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ - 249</title>
  <link rel="stylesheet" href="/static/style.css">
  <style>
    body{background:#f5f7fa;font-family:'Bahij',Tahoma,Arial,sans-serif;margin:0;padding:0}
    
    .top-bar{background:#fff;padding:16px 24px;box-shadow:0 2px 8px rgba(0,0,0,.05);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100}
    .top-bar h1{margin:0;font-size:22px;color:#1e293b}
    .top-bar .actions{display:flex;gap:16px;align-items:center}
    .top-bar a{color:#64748b;text-decoration:none;font-size:14px;transition:.2s}
    .top-bar a:hover{color:#1e293b}
    .logout-link{color:#ef4444!important}
    
    .main-container{max-width:1400px;margin:24px auto;padding:0 20px;display:grid;grid-template-columns:320px 1fr;gap:20px}
    
    /* Sidebar */
    .sidebar{background:#fff;border-radius:12px;padding:20px;box-shadow:0 2px 12px rgba(0,0,0,.06);height:fit-content;position:sticky;top:80px}
    .add-client-btn{width:100%;padding:12px;background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;margin-bottom:16px;transition:.2s}
    .add-client-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(59,130,246,.3)}
    
    .search-box{position:relative;margin-bottom:16px}
    .search-box input{width:100%;padding:10px 36px 10px 12px;border:1px solid #e2e8f0;border-radius:8px;font-size:14px;transition:.2s}
    .search-box input:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.1)}
    .search-box::after{content:"ğŸ”";position:absolute;left:12px;top:50%;transform:translateY(-50%);pointer-events:none}
    
    .clients-list{max-height:calc(100vh - 300px);overflow-y:auto;padding-left:4px}
    .client-card{background:#f8fafc;padding:12px;margin-bottom:8px;border-radius:8px;cursor:pointer;transition:.2s;border:2px solid transparent}
    .client-card:hover{background:#e0f2fe;border-color:#3b82f6}
    .client-card.active{background:#3b82f6;color:#fff;border-color:#2563eb}
    .client-card .name{font-weight:600;margin-bottom:4px;font-size:15px}
    .client-card .code{font-size:12px;opacity:.8}
    .client-card.has-changes{position:relative}
    .client-card.has-changes::before{content:"â—";position:absolute;top:8px;left:8px;color:#f59e0b;font-size:12px}
    .empty-list{text-align:center;padding:40px 20px;color:#94a3b8;font-size:14px}
    
    /* Main Panel */
    .main-panel{background:#fff;border-radius:12px;padding:28px;box-shadow:0 2px 12px rgba(0,0,0,.06);min-height:600px}
    .empty-state{text-align:center;padding:80px 20px;color:#94a3b8}
    .empty-state svg{width:100px;height:100px;margin-bottom:16px;opacity:.5}
    
    .client-header{border-bottom:2px solid #f1f5f9;padding-bottom:20px;margin-bottom:24px}
    .client-header h2{margin:0 0 8px;font-size:24px;color:#0f172a}
    .client-header .meta{color:#64748b;font-size:14px}
    
    .stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:28px}
    .stat-box{background:linear-gradient(135deg,#f8fafc,#f1f5f9);padding:16px;border-radius:10px;text-align:center}
    .stat-box .number{font-size:28px;font-weight:700;color:#0f172a}
    .stat-box .label{font-size:13px;color:#64748b;margin-top:4px}
    
    .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .section-title{font-size:18px;font-weight:600;color:#1e293b}
    .add-step-btn{padding:8px 16px;background:#10b981;color:#fff;border:none;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;transition:.2s}
    .add-step-btn:hover{background:#059669;transform:translateY(-1px)}
    
    /* Save Button */
    .save-bar{position:fixed;bottom:0;left:0;right:0;background:#fff;padding:16px 24px;box-shadow:0 -4px 20px rgba(0,0,0,.1);display:none;align-items:center;justify-content:center;gap:16px;z-index:200;animation:slideUp .3s}
    .save-bar.show{display:flex}
    @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
    .save-bar .info{color:#64748b;font-size:14px}
    .save-bar .info .count{color:#f59e0b;font-weight:700}
    .save-changes-btn{padding:12px 32px;background:linear-gradient(135deg,#10b981,#059669);color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:15px;transition:.2s;box-shadow:0 4px 12px rgba(16,185,129,.3)}
    .save-changes-btn:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(16,185,129,.4)}
    .cancel-changes-btn{padding:12px 24px;background:#f1f5f9;color:#64748b;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:.2s}
    .cancel-changes-btn:hover{background:#e2e8f0;color:#334155}
    
    /* Steps List - Enhanced */
    .steps-container{display:grid;gap:8px;position:relative}
    .step-row{background:#fafbfc;padding:12px 16px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;border-left:3px solid #e2e8f0;transition:all .3s cubic-bezier(0.4, 0, 0.2, 1);cursor:move;user-select:none;position:relative}
    .step-row:hover{background:#f1f5f9;border-left-color:#3b82f6;transform:translateX(-4px)}
    .step-row.enabled{background:#fff;border-left-color:#3b82f6}
    .step-row.enabled.done{background:#f0fdf4;border-left-color:#10b981}
    
    /* Drag States - Enhanced */
    .step-row.dragging{opacity:.5;transform:scale(0.98) rotate(2deg);box-shadow:0 8px 24px rgba(0,0,0,.2);z-index:1000;cursor:grabbing!important}
    .step-row.drag-over{border-top:3px solid #3b82f6;margin-top:8px;transform:translateY(4px)}
    .step-row.drag-placeholder{background:#e0f2fe;border-left-color:#3b82f6;opacity:.3;border-style:dashed}
    
    .step-info{flex:1}
    .step-name{font-weight:500;color:#1e293b;font-size:15px}
    .step-status{font-size:12px;color:#94a3b8;margin-top:2px}
    .step-status.active{color:#3b82f6}
    .step-status.completed{color:#10b981}
    
    .step-controls{display:flex;gap:8px;align-items:center}
    
    /* Toggle Switch */
    .switch{position:relative;width:44px;height:24px;cursor:pointer}
    .switch input{opacity:0;width:0;height:0}
    .slider{position:absolute;inset:0;background:#cbd5e1;border-radius:24px;transition:.3s}
    .slider:before{content:"";position:absolute;height:18px;width:18px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.3s;box-shadow:0 2px 4px rgba(0,0,0,.2)}
    .switch input:checked + .slider{background:#3b82f6}
    .switch input:checked + .slider:before{transform:translateX(20px)}
    
    /* Checkbox */
    .checkbox-wrapper{position:relative;width:22px;height:22px}
    .checkbox-wrapper input{position:absolute;opacity:0;cursor:pointer;width:100%;height:100%}
    .checkmark{position:absolute;top:0;left:0;height:22px;width:22px;background:#fff;border:2px solid #cbd5e1;border-radius:5px;transition:.2s}
    .checkbox-wrapper:hover .checkmark{border-color:#3b82f6}
    .checkbox-wrapper input:checked ~ .checkmark{background:#10b981;border-color:#10b981}
    .checkmark:after{content:"";position:absolute;display:none;left:6px;top:2px;width:5px;height:10px;border:solid white;border-width:0 2px 2px 0;transform:rotate(45deg)}
    .checkbox-wrapper input:checked ~ .checkmark:after{display:block}
    .checkbox-wrapper input:disabled ~ .checkmark{background:#f1f5f9;border-color:#e2e8f0;cursor:not-allowed}
    
    .drag-handle{cursor:grab;color:#cbd5e1;font-size:18px;margin-left:8px;transition:color .2s}
    .drag-handle:hover{color:#64748b}
    .drag-handle:active{cursor:grabbing}
    
    .loading{text-align:center;padding:60px;color:#94a3b8}
    .spinner{display:inline-block;width:40px;height:40px;border:4px solid #e2e8f0;border-top-color:#3b82f6;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    
    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1000}
    .modal.show{display:flex}
    .modal-content{background:#fff;padding:28px;border-radius:12px;max-width:440px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.3);animation:modalSlideUp .3s}
    @keyframes modalSlideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:none}}
    .modal-content h3{margin:0 0 20px;font-size:20px}
    .modal-input{width:100%;padding:12px;border:1px solid #e2e8f0;border-radius:8px;margin-bottom:14px;font-size:15px}
    .modal-input:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.1)}
    .modal-actions{display:flex;gap:10px;margin-top:20px}
    .modal-btn{flex:1;padding:12px;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:.2s}
    .modal-btn.primary{background:#3b82f6;color:#fff}
    .modal-btn.primary:hover{background:#2563eb}
    .modal-btn.secondary{background:#f1f5f9;color:#334155}
    
    @media (max-width:1024px){
      .main-container{grid-template-columns:1fr;gap:16px}
      .sidebar{position:static}
    }
  </style>
</head>
<body>
  <!-- Top Bar -->
  <div class="top-bar">
    <h1>ğŸ“‹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ù…Ø±Ø§Ø­Ù„</h1>
    <div class="actions">
      <a href="/">â† Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      <a href="/admin/logout" class="logout-link">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</a>
    </div>
  </div>
  
  <!-- Main Container -->
  <div class="main-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <button class="add-client-btn" onclick="openModal('addClient')">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
      
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„...">
      </div>
      
      <div id="clientsList" class="clients-list">
        <div class="loading"><div class="spinner"></div></div>
      </div>
    </aside>
    
    <!-- Main Panel -->
    <main class="main-panel">
      <div id="mainContent" class="empty-state">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
        </svg>
        <h3>Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</h3>
        <p>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ø¹Ù…ÙŠÙ„ Ù„Ø¹Ø±Ø¶ ÙˆØ¥Ø¯Ø§Ø±Ø© Ù…Ø±Ø§Ø­Ù„Ù‡</p>
      </div>
    </main>
  </div>
  
  <!-- Save Bar -->
  <div id="saveBar" class="save-bar">
    <div class="info">Ù„Ø¯ÙŠÙƒ <span class="count" id="changesCount">0</span> ØªØºÙŠÙŠØ± ØºÙŠØ± Ù…Ø­ÙÙˆØ¸</div>
    <button class="cancel-changes-btn" onclick="cancelChanges()">Ø¥Ù„ØºØ§Ø¡</button>
    <button class="save-changes-btn" onclick="saveAllChanges()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
  </div>
  
  <!-- Modal: Add Client -->
  <div id="addClientModal" class="modal">
    <div class="modal-content">
      <h3>â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h3>
      <input type="text" id="clientName" class="modal-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
      <input type="text" id="clientService" class="modal-input" placeholder="Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©">
      <div class="modal-actions">
        <button class="modal-btn primary" onclick="submitAddClient()">Ø­ÙØ¸</button>
        <button class="modal-btn secondary" onclick="closeModal('addClient')">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>
  
  <!-- Modal: Add Step -->
  <div id="addStepModal" class="modal">
    <div class="modal-content">
      <h3>ğŸ“ Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
      <input type="text" id="stepName" class="modal-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø­Ù„Ø©">
      <div class="modal-actions">
        <button class="modal-btn primary" onclick="submitAddStep()">Ø­ÙØ¸</button>
        <button class="modal-btn secondary" onclick="closeModal('addStep')">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>
  
  <script>
    let allClients = [];
    let currentClient = null;
    let originalStepsOrder = [];
    let currentStepsOrder = [];
    let pendingChanges = {
      order: false,
      toggles: new Set(),
      doneToggles: new Set()
    };
    
    document.addEventListener('DOMContentLoaded', loadClients);
    
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase();
      const filtered = allClients.filter(c => 
        c.name.toLowerCase().includes(query) || c.code.toLowerCase().includes(query)
      );
      renderClients(filtered);
    });
    
    async function loadClients() {
      const list = document.getElementById('clientsList');
      try {
        const res = await fetch('/admin/api/clients');
        allClients = await res.json();
        renderClients(allClients);
      } catch (err) {
        list.innerHTML = '<div class="empty-list">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</div>';
      }
    }
    
    function renderClients(clients) {
      const list = document.getElementById('clientsList');
      if (!clients.length) {
        list.innerHTML = '<div class="empty-list">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡</div>';
        return;
      }
      
      list.innerHTML = clients.map(c => `
        <div class="client-card ${currentClient?.code === c.code ? 'active' : ''} ${hasClientChanges(c.code) ? 'has-changes' : ''}" 
             onclick="loadClient('${c.code}', '${escapeHtml(c.name)}', '${escapeHtml(c.service)}')">
          <div class="name">${c.name}</div>
          <div class="code">${c.code}</div>
        </div>
      `).join('');
    }
    
    function hasClientChanges(code) {
      return currentClient?.code === code && getTotalChanges() > 0;
    }
    
    async function loadClient(code, name, service) {
      if (getTotalChanges() > 0) {
        if (!confirm('Ù„Ø¯ÙŠÙƒ ØªØºÙŠÙŠØ±Ø§Øª ØºÙŠØ± Ù…Ø­ÙÙˆØ¸Ø©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø¯ÙˆÙ† Ø­ÙØ¸ØŸ')) {
          return;
        }
        resetChanges();
      }
      
      currentClient = { code, name, service };
      
      document.querySelectorAll('.client-card').forEach(el => el.classList.remove('active'));
      event.target.closest('.client-card').classList.add('active');
      
      const panel = document.getElementById('mainContent');
      panel.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      
      try {
        const res = await fetch(`/admin/api/client/${code}/all-steps`);
        const steps = await res.json();
        
        originalStepsOrder = steps.map(s => s.name);
        currentStepsOrder = [...originalStepsOrder];
        
        const enabled = steps.filter(s => s.enabled).length;
        const done = steps.filter(s => s.done).length;
        const progress = enabled ? Math.round((done / enabled) * 100) : 0;
        
        panel.innerHTML = `
          <div class="client-header">
            <h2>${name}</h2>
            <div class="meta">ÙƒÙˆØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©: <strong>${code}</strong> â€¢ Ø§Ù„Ø®Ø¯Ù…Ø©: ${service || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
          </div>
          
          <div class="stats-row">
            <div class="stat-box">
              <div class="number">${enabled}</div>
              <div class="label">Ù…Ø±Ø§Ø­Ù„ Ù…ÙØ¹Ù‘Ù„Ø©</div>
            </div>
            <div class="stat-box">
              <div class="number">${done}</div>
              <div class="label">Ù…ÙƒØªÙ…Ù„Ø©</div>
            </div>
            <div class="stat-box">
              <div class="number">${progress}%</div>
              <div class="label">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</div>
            </div>
          </div>
          
          <div class="section-header">
            <div class="section-title">Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ù…ØªØ§Ø­Ø© (Ø§Ø³Ø­Ø¨ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ØªÙŠØ¨)</div>
            <button class="add-step-btn" onclick="openModal('addStep')">+ Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø­Ù„Ø©</button>
          </div>
          
          <div class="steps-container" id="stepsList">
            ${renderSteps(steps)}
          </div>
        `;
        
        setTimeout(initDragAndDrop, 100);
        
      } catch (err) {
        panel.innerHTML = '<div class="empty-state"><p style="color:#ef4444">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</p></div>';
      }
    }
    
    function renderSteps(steps) {
      return steps.map(s => `
        <div class="step-row ${s.enabled ? 'enabled' : ''} ${s.done ? 'done' : ''}" 
             draggable="true" 
             data-step="${escapeHtml(s.name)}">
          <div class="step-info" style="display:flex;align-items:center;gap:8px">
            <span class="drag-handle">â‹®â‹®</span>
            <div>
              <div class="step-name">${s.name}</div>
              <div class="step-status ${s.enabled ? (s.done ? 'completed' : 'active') : ''}">
                ${s.enabled ? (s.done ? 'âœ“ Ù…ÙƒØªÙ…Ù„Ø©' : 'â—‹ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±') : 'â€¢ ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„Ø©'}
              </div>
            </div>
          </div>
          <div class="step-controls">
            ${s.enabled ? `
              <div class="checkbox-wrapper" title="ØªØ¹Ù„ÙŠÙ… ÙƒÙ…ÙƒØªÙ…Ù„Ø©">
                <input type="checkbox" ${s.done ? 'checked' : ''} 
                       onchange="toggleDonePending('${escapeHtml(s.name)}', this.checked)">
                <span class="checkmark"></span>
              </div>
            ` : ''}
            <label class="switch" title="${s.enabled ? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªÙØ¹ÙŠÙ„' : 'ØªÙØ¹ÙŠÙ„'}">
              <input type="checkbox" ${s.enabled ? 'checked' : ''} 
                     onchange="toggleEnabledPending('${escapeHtml(s.name)}', this.checked)">
              <span class="slider"></span>
            </label>
          </div>
        </div>
      `).join('');
    }
    
    function toggleEnabledPending(stepName, isEnabled) {
      const key = `${currentClient.code}:${stepName}:enabled`;
      if (pendingChanges.toggles.has(key)) {
        pendingChanges.toggles.delete(key);
      } else {
        pendingChanges.toggles.add(key);
      }
      updateChangesUI();
    }
    
    function toggleDonePending(stepName, isDone) {
      const key = `${currentClient.code}:${stepName}:done`;
      if (pendingChanges.doneToggles.has(key)) {
        pendingChanges.doneToggles.delete(key);
      } else {
        pendingChanges.doneToggles.add(key);
      }
      updateChangesUI();
    }
    
    function getTotalChanges() {
      let count = 0;
      if (pendingChanges.order) count++;
      count += pendingChanges.toggles.size;
      count += pendingChanges.doneToggles.size;
      return count;
    }
    
    function updateChangesUI() {
      const count = getTotalChanges();
      const saveBar = document.getElementById('saveBar');
      const changesCount = document.getElementById('changesCount');
      
      if (count > 0) {
        saveBar.classList.add('show');
        changesCount.textContent = count;
      } else {
        saveBar.classList.remove('show');
      }
      
      renderClients(allClients);
    }
    
    async function saveAllChanges() {
      const saveBtn = document.querySelector('.save-changes-btn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'â³ Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸...';
      
      try {
        // 1. Ø­ÙØ¸ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        if (pendingChanges.order) {
          await fetch('/admin/api/reorder-steps', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ steps: currentStepsOrder })
          });
        }
        
        // 2. Ø­ÙØ¸ ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„ØªÙØ¹ÙŠÙ„
        for (const change of pendingChanges.toggles) {
          const [code, stepName] = change.split(':');
          await fetch(`/admin/api/client/${code}/toggle-step`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ step: stepName })
          });
        }
        
        // 3. Ø­ÙØ¸ ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„
        for (const change of pendingChanges.doneToggles) {
          const [code, stepName] = change.split(':');
          await fetch(`/admin/api/client/${code}/toggle-done`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ step: stepName })
          });
        }
        
        alert('âœ… ØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
        resetChanges();
        loadClient(currentClient.code, currentClient.name, currentClient.service);
        
      } catch (err) {
        alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸');
        console.error(err);
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª';
      }
    }
    
    function cancelChanges() {
      if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§ØªØŸ')) {
        resetChanges();
        loadClient(currentClient.code, currentClient.name, currentClient.service);
      }
    }
    
    function resetChanges() {
      pendingChanges = {
        order: false,
        toggles: new Set(),
        doneToggles: new Set()
      };
      updateChangesUI();
    }
    
    function openModal(type) {
      document.getElementById(type + 'Modal').classList.add('show');
      if (type === 'addClient') {
        document.getElementById('clientName').value = '';
        document.getElementById('clientService').value = '';
      } else {
        document.getElementById('stepName').value = '';
      }
    }
    
    function closeModal(type) {
      document.getElementById(type + 'Modal').classList.remove('show');
    }
    
    async function submitAddClient() {
      const name = document.getElementById('clientName').value.trim();
      const service = document.getElementById('clientService').value.trim();
      
      if (!name) { alert('Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø·Ù„ÙˆØ¨'); return; }
      
      try {
        const res = await fetch('/admin/api/add-client', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, service })
        });
        const data = await res.json();
        if (data.ok) {
          alert(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!\nÙƒÙˆØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©: ${data.code}`);
          closeModal('addClient');
          loadClients();
        }
      } catch (err) {
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£');
      }
    }
    
    async function submitAddStep() {
      const step = document.getElementById('stepName').value.trim();
      if (!step) { alert('Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ù…Ø·Ù„ÙˆØ¨'); return; }
      
      try {
        const res = await fetch('/admin/api/add-step', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ step })
        });
        if (res.ok) {
          alert('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­');
          closeModal('addStep');
          if (currentClient) loadClient(currentClient.code, currentClient.name, currentClient.service);
        }
      } catch (err) {
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£');
      }
    }
    
    function escapeHtml(text) {
      const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
      return text.replace(/[&<>"']/g, m => map[m]);
    }
    
    // ==================== Enhanced Drag & Drop ====================
    let draggedElement = null;
    let placeholder = null;
    
    function initDragAndDrop() {
      const stepRows = document.querySelectorAll('.step-row');
      
      stepRows.forEach(row => {
        row.addEventListener('dragstart', handleDragStart);
        row.addEventListener('dragover', handleDragOver);
        row.addEventListener('drop', handleDrop);
        row.addEventListener('dragend', handleDragEnd);
        row.addEventListener('dragleave', handleDragLeave);
        row.addEventListener('dragenter', handleDragEnter);
      });
    }
    
    function createPlaceholder() {
      if (!placeholder) {
        placeholder = document.createElement('div');
        placeholder.className = 'step-row drag-placeholder';
        placeholder.style.height = draggedElement ? draggedElement.offsetHeight + 'px' : '60px';
        placeholder.innerHTML = '<div style="text-align:center;color:#3b82f6">â†“ Ø£ÙÙ„Øª Ù‡Ù†Ø§ â†“</div>';
      }
      return placeholder;
    }
    
    function handleDragStart(e) {
      draggedElement = this;
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', this.innerHTML);
      
      setTimeout(() => {
        const ph = createPlaceholder();
        this.parentNode.insertBefore(ph, this);
        this.style.display = 'none';
      }, 0);
    }
    
    function handleDragEnter(e) {
      e.preventDefault();
      if (this !== draggedElement && this !== placeholder) {
        this.classList.add('drag-over');
      }
    }
    
    function handleDragOver(e) {
      if (e.preventDefault) {
        e.preventDefault();
      }
      
      e.dataTransfer.dropEffect = 'move';
      
      if (this !== draggedElement && this !== placeholder) {
        const container = this.parentNode;
        const allRows = Array.from(container.querySelectorAll('.step-row:not(.dragging):not(.drag-placeholder)'));
        const afterElement = getDragAfterElement(container, e.clientY);
        
        if (placeholder) {
          if (afterElement == null) {
            container.appendChild(placeholder);
          } else {
            container.insertBefore(placeholder, afterElement);
          }
        }
      }
      
      return false;
    }
    
    function getDragAfterElement(container, y) {
      const draggableElements = [...container.querySelectorAll('.step-row:not(.dragging):not(.drag-placeholder)')];
      
      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        
        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }
    
    function handleDragLeave(e) {
      this.classList.remove('drag-over');
    }
    
    function handleDrop(e) {
      if (e.stopPropagation) {
        e.stopPropagation();
      }
      
      e.preventDefault();
      
      if (placeholder && draggedElement) {
        placeholder.parentNode.insertBefore(draggedElement, placeholder);
        draggedElement.style.display = '';
        placeholder.remove();
        
        updateStepsOrder();
      }
      
      this.classList.remove('drag-over');
      return false;
    }
    
    function handleDragEnd(e) {
      this.classList.remove('dragging');
      this.style.display = '';
      
      if (placeholder && placeholder.parentNode) {
        placeholder.remove();
      }
      
      document.querySelectorAll('.step-row').forEach(row => {
        row.classList.remove('drag-over');
      });
      
      draggedElement = null;
      placeholder = null;
    }
    
    function updateStepsOrder() {
      const rows = document.querySelectorAll('.step-row:not(.drag-placeholder)');
      currentStepsOrder = Array.from(rows).map(row => row.dataset.step);
      
      const orderChanged = JSON.stringify(currentStepsOrder) !== JSON.stringify(originalStepsOrder);
      pendingChanges.order = orderChanged;
      
      updateChangesUI();
    }
  </script>
</body>
</html>
