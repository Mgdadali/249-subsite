<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>إدارة العملاء</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<div class="admin-layout">

  <!-- Sidebar -->
  <aside class="admin-sidebar">
    <h4>العملاء</h4>

    <!-- Searchable Dropdown -->
    <div class="dropdown">
      <input type="text" id="clientSearch" placeholder="ابحث عن عميل">
      <div id="clientList" class="dropdown-list"></div>
    </div>

    <button class="admin-small-btn" onclick="openAddClientModal()">
      ➕ إضافة عميل جديد
    </button>
  </aside>

  <!-- Main Content -->
  <main class="admin-main">
    <h3 id="selectedClientTitle">اختر عميل لعرض المراحل</h3>
    <div id="stepsList"></div>
  </main>

</div>

<!-- Add Client Modal -->
<div id="addClientModal" class="modal">
  <div class="modal-content">
    <h3>إضافة عميل جديد</h3>

    <input id="newClientName" placeholder="اسم العميل">
    <input id="newClientService" placeholder="نوع الخدمة">

    <button onclick="submitClient()">إضافة</button>
    <button class="danger" onclick="closeAddClientModal()">إغلاق</button>
  </div>
</div>

<script>
let clientsCache = {};
let currentCode = null;

/* ================= Load Clients ================= */
function loadClients(){
  fetch("/admin/api/clients")
    .then(r => r.json())
    .then(data => {
      let list = document.getElementById("clientList");
      list.innerHTML = "";
      data.forEach(c => {
        clientsCache[c.code] = c;
        let div = document.createElement("div");
        div.className = "client-option";
        div.innerText = `${c.name} (${c.code})`;
        div.onclick = () => selectClient(c.code);
        list.appendChild(div);
      });
    });
}

/* Initial load */
loadClients();

/* ================= Dropdown Filter ================= */
document.getElementById("clientSearch").addEventListener("input", e => {
  let val = e.target.value.toLowerCase();
  document.querySelectorAll(".client-option").forEach(el=>{
    el.style.display = el.innerText.toLowerCase().includes(val) ? "block" : "none";
  });
});

/* ================= Select Client ================= */
function selectClient(code){
  currentCode = code;
  document.getElementById("selectedClientTitle").innerText =
    clientsCache[code].name + " — " + clientsCache[code].service;

  loadChecklist(code);
}

/* ================= Load Checklist ================= */
function loadChecklist(code){
  fetch(`/admin/api/client/${code}/checklist`)
    .then(r => r.json())
    .then(data => {
      let box = document.getElementById("stepsList");
      box.innerHTML = "";

      if(data.steps.length === 0){
        box.innerHTML = "<p>لا توجد مراحل بعد</p>";
        return;
      }

      data.steps.forEach(s=>{
        let row = document.createElement("div");
        row.className = "step-row";

        row.innerHTML = `
          <span>${s.name}</span>
          <div>
            <button class="admin-action ${s.done?'done':''}"
              onclick="toggleStep('${s.name}')">
              ${s.done?'✔':'○'}
            </button>
            <button class="admin-action danger"
              onclick="deleteStep('${s.name}')">
              ✖
            </button>
          </div>
        `;
        box.appendChild(row);
      });
    });
}

/* ================= Toggle Step ================= */
function toggleStep(step){
  fetch(`/admin/api/client/${currentCode}/toggle-step`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({step})
  }).then(()=>loadChecklist(currentCode));
}

/* ================= Delete Step ================= */
function deleteStep(step){
  if(!confirm("حذف المرحلة؟")) return;
  fetch(`/admin/api/client/${currentCode}/delete-step`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({step})
  }).then(()=>loadChecklist(currentCode));
}

/* ================= Modal Add Client ================= */
function openAddClientModal(){
  document.getElementById("addClientModal").style.display="block";
}

function closeAddClientModal(){
  document.getElementById("addClientModal").style.display="none";
}

function submitClient(){
  let name = document.getElementById("newClientName").value;
  let service = document.getElementById("newClientService").value;
  if(!name) return alert("الرجاء إدخال اسم العميل");

  fetch("/admin/api/add-client",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({name,service})
  }).then(r=>r.json())
    .then(data=>{
      closeAddClientModal();
      loadClients();
      alert(`تم إضافة العميل ✅ كود: ${data.code}`);
    });
}
</script>

</body>
</html>
