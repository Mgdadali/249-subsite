<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Admin Manage</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- ====== STYLE ====== -->
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, sans-serif;
      background: #f4f6f9;
      color: #333;
    }

    /* ====== Header ====== */
    header {
      background: linear-gradient(90deg, #1e88e5, #fb8c00);
      color: #fff;
      padding: 14px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      margin: 0;
      font-size: 18px;
    }

    header a {
      color: #fff;
      text-decoration: none;
      font-weight: bold;
    }

    /* ====== Layout ====== */
    .container {
      max-width: 1100px;
      margin: 20px auto;
      padding: 0 15px;
    }

    /* ====== Dropdown ====== */
    .select-box {
      position: relative;
      max-width: 400px;
      margin-bottom: 20px;
    }

    .select-display {
      background: #fff;
      border: 1px solid #ddd;
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }

    .dropdown {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      left: 0;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-top: 5px;
      z-index: 10;
      max-height: 260px;
      overflow-y: auto;
    }

    .dropdown.show {
      display: block;
    }

    .dropdown input {
      width: 100%;
      padding: 10px;
      border: none;
      border-bottom: 1px solid #eee;
      outline: none;
    }

    .client-option {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #f1f1f1;
    }

    .client-option:hover {
      background: #f0f7ff;
    }

    /* ====== Card ====== */
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      margin-top: 20px;
    }

    .card h2 {
      margin-top: 0;
      font-size: 18px;
    }

    /* ====== Steps ====== */
    .step-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }

    .step-row:last-child {
      border-bottom: none;
    }

    .admin-action {
      border: 1px solid #ccc;
      background: #fff;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 16px;
    }

    .admin-action.done {
      background: #1e88e5;
      color: #fff;
      border-color: #1e88e5;
    }

    /* ====== Buttons ====== */
    .actions {
      margin-top: 15px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .add-step-btn,
    .save-btn {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }

    .add-step-btn {
      background: #fb8c00;
      color: #fff;
    }

    .save-btn {
      background: #1e88e5;
      color: #fff;
    }

  </style>
</head>

<body>

<header>
  <h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h1>
  <a href="/admin/logout">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</a>
</header>

<div class="container">

  <!-- ====== Client Select ====== -->
  <button class="add-client-btn" onclick="openAddClientModal()">
  <span>â•</span> Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯
</button>


  <div class="select-box">
    <div class="select-display" onclick="toggleDropdown()">
      Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„
    </div>

    <div class="dropdown" id="clientDropdown">
      <input type="text" placeholder="Ø¨Ø­Ø«..." onkeyup="filterClients(this.value)">
      <div id="clientList"></div>
    </div>
  </div>

  <!-- ====== Steps Card ====== -->
  <div class="card" id="stepsCard" style="display:none;">
    <h2 id="clientTitle"></h2>

    <div id="stepsList"></div>

    <div class="actions">
      <button class="add-step-btn" onclick="addStep()">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø­Ù„Ø©</button>
      <button class="save-btn" onclick="saveChanges()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
    </div>
  </div>

</div>

<!-- ====== SCRIPT ====== -->
<script>
let clientsCache = {};
let currentCode = null;
let pending = {};
let lastSteps = [];

/* ---------- Dropdown ---------- */
function toggleDropdown(){
  document.getElementById("clientDropdown").classList.toggle("show");
}

/* ---------- Load Clients ---------- */
fetch("/admin/api/clients")
.then(r=>r.json())
.then(data=>{
  let list = document.getElementById("clientList");
  list.innerHTML = "";
  data.forEach(c=>{
    clientsCache[c.code] = c;
    let d = document.createElement("div");
    d.className = "client-option";
    d.innerText = `${c.name} (${c.code})`;
    d.onclick = ()=>selectClient(c.code);
    list.appendChild(d);
  });
});

function filterClients(q){
  q = q.toLowerCase();
  document.querySelectorAll(".client-option").forEach(el=>{
    el.style.display = el.innerText.toLowerCase().includes(q) ? "" : "none";
  });
}

/* ---------- Select Client ---------- */
function selectClient(code){
  currentCode = code;
  pending = {};
  document.querySelector(".select-display").innerText =
    clientsCache[code].name + " â€” " + clientsCache[code].service;
  document.getElementById("clientDropdown").classList.remove("show");
  loadChecklist(code);
}

/* ---------- Load All Steps ---------- */
function loadChecklist(code){
  fetch(`/admin/api/client/${code}/all-steps`)
  .then(r=>r.json())
  .then(steps=>{
    lastSteps = steps;
    document.getElementById("stepsCard").style.display = "block";
    document.getElementById("clientTitle").innerText =
      "Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„ ("+code+")";

    let box = document.getElementById("stepsList");
    box.innerHTML = "";

    steps.forEach(s=>{
      let current = (s.name in pending) ? pending[s.name] : s.done;

      let row = document.createElement("div");
      row.className = "step-row";
      row.innerHTML = `
        <span>${s.name}</span>
        <button class="admin-action ${current?'done':''}"
          onclick="toggleLocal('${s.name}', ${current})">
          ${current?'âœ”':'â—‹'}
        </button>
      `;
      box.appendChild(row);
    });
  });
}

/* ---------- Toggle (Local Only) ---------- */
function toggleLocal(step, current){
  pending[step] = !current;
  loadChecklist(currentCode);
}

/* ---------- Save ---------- */
function saveChanges(){
  fetch(`/admin/api/client/${currentCode}/save-steps`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({steps: pending})
  })
  .then(r=>r.json())
  .then(()=>{
    pending = {};
    loadChecklist(currentCode);
    alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…");
  });
}

/* ---------- Add Step (Global) ---------- */
function addStep(){
  let step = prompt("Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:");
  if(!step) return;

  fetch("/admin/api/add-step",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({step: step})
  })
  .then(()=>loadChecklist(currentCode));
}
</script>
  <div id="addClientModal" class="modal" style="display:none;">
  <div class="modal-content">
    <h3>Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h3>

    <input type="text" id="newClientName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
    <input type="text" id="newClientService" placeholder="Ø§Ù„Ø®Ø¯Ù…Ø©">

    <div style="margin-top:10px;">
      <button onclick="addClient()">Ø­ÙØ¸</button>
      <button onclick="closeAddClientModal()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>
  <script>
function openAddClientModal(){
  document.getElementById("addClientModal").style.display = "block";
}

function closeAddClientModal(){
  document.getElementById("addClientModal").style.display = "none";
}

function addClient(){
  let name = document.getElementById("newClientName").value;
  let service = document.getElementById("newClientService").value;

  if(!name){
    alert("Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø·Ù„ÙˆØ¨");
    return;
  }

  fetch("/admin/api/add-client",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ name, service })
  })
  .then(r=>r.json())
  .then(res=>{
    if(res.ok){
      alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
      closeAddClientModal();
      loadClients(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
    }
  });
}
</script>



</body>
</html>

/* Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ */
.add-client-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 12px 18px;
  font-size: 14px;
  font-weight: 600;
  color: #fff;
  background: linear-gradient(135deg, #1e88e5, #fb8c00);
  border: none;
  border-radius: 10px;
  cursor: pointer;
  box-shadow: 0 8px 20px rgba(0,0,0,0.15);
  transition: all 0.3s ease;
}

.add-client-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 25px rgba(0,0,0,0.25);
}

/* Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.6);
  backdrop-filter: blur(6px);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 999;
}

/* Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
.modal-content {
  width: 380px;
  background: #fff;
  border-radius: 14px;
  padding: 22px;
  animation: slideUp 0.35s ease;
}

/* Ø¹Ù†ÙˆØ§Ù† */
.modal-content h3 {
  margin-bottom: 15px;
  color: #1e3a8a;
  font-size: 18px;
}

/* Ø§Ù„Ø­Ù‚ÙˆÙ„ */
.modal-content input {
  width: 100%;
  padding: 10px 12px;
  margin-bottom: 12px;
  border-radius: 8px;
  border: 1px solid #ddd;
  font-size: 14px;
}

/* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
.modal-content button {
  padding: 10px 14px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-weight: 600;
}

.modal-content button:first-child {
  background: #fb8c00;
  color: #fff;
}

.modal-content button:last-child {
  background: #e5e7eb;
  margin-left: 8px;
}

/* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† */
@keyframes slideUp {
  from {
    transform: translateY(30px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}




