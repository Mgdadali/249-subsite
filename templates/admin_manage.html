<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ - 249</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    .admin-layout{display:grid;grid-template-columns:280px 1fr;gap:20px;max-width:1200px;margin:30px auto;padding:0 20px}
    .sidebar{background:#fff;border-radius:12px;padding:16px;box-shadow:0 4px 12px rgba(0,0,0,.06);height:fit-content;position:sticky;top:20px}
    .main-panel{background:#fff;border-radius:12px;padding:24px;box-shadow:0 4px 12px rgba(0,0,0,.06);min-height:600px}
    
    .search-input{width:100%;padding:10px 12px;border:1px solid #e0e7f1;border-radius:8px;margin-bottom:12px;font-size:14px}
    .search-input:focus{outline:none;border-color:#1e90ff;box-shadow:0 0 0 3px rgba(30,144,255,.1)}
    
    .client-item{display:block;width:100%;padding:12px;margin-bottom:8px;background:#f8fbff;border:1px solid #e6f0ff;border-radius:8px;text-align:right;cursor:pointer;transition:.2s}
    .client-item:hover{background:#e6f0ff;transform:translateX(-3px)}
    .client-item.active{background:#1e90ff;color:#fff;border-color:#1e90ff}
    
    .btn-add{width:100%;padding:12px;background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;margin-bottom:16px}
    .btn-add:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(34,197,94,.3)}
    
    .step-item{display:flex;justify-content:space-between;align-items:center;padding:14px;margin-bottom:10px;background:#f9fafb;border-radius:10px;border-right:4px solid #cbd5e1}
    .step-item.done{background:#f0fdf4;border-right-color:#22c55e}
    
    .step-actions{display:flex;gap:8px}
    .btn-sm{padding:6px 14px;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;transition:.2s}
    .btn-toggle{background:#3b82f6;color:#fff}
    .btn-toggle:hover{background:#2563eb}
    .btn-delete{background:#ef4444;color:#fff}
    .btn-delete:hover{background:#dc2626}
    
    .empty-state{text-align:center;padding:60px 20px;color:#94a3b8}
    .empty-state img{width:120px;opacity:.5;margin-bottom:16px}
    
    .loading{text-align:center;padding:40px;color:#64748b}
    .spinner{display:inline-block;width:32px;height:32px;border:3px solid #e2e8f0;border-top-color:#3b82f6;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    
    .panel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .panel-title{font-size:20px;font-weight:700;color:#0f172a}
    
    .stats-card{background:linear-gradient(135deg,#3b82f6,#1e40af);color:#fff;padding:16px;border-radius:10px;margin-bottom:20px}
    .stats-card h4{margin:0 0 8px;font-size:14px;opacity:.9}
    .stats-card .number{font-size:28px;font-weight:700}
    
    @media (max-width:900px){
      .admin-layout{grid-template-columns:1fr;gap:16px}
      .sidebar{position:static}
    }
  </style>
</head>
<body>
  <div class="container" style="max-width:1240px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <h2>ğŸ“‹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ù…Ø±Ø§Ø­Ù„</h2>
      <div>
        <a href="/admin/dashboard" style="margin-left:16px;color:#64748b;text-decoration:none">â† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
        <a href="/admin/logout" style="color:#ef4444;text-decoration:none">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</a>
      </div>
    </div>
    
    <div class="admin-layout">
      <!-- Sidebar -->
      <aside class="sidebar">
        <button class="btn-add" onclick="openAddClientModal()">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
        <input type="text" class="search-input" id="searchClients" placeholder="ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„...">
        <div id="clientsList" class="loading">
          <div class="spinner"></div>
          <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
        </div>
      </aside>
      
      <!-- Main Panel -->
      <main class="main-panel">
        <div id="mainContent" class="empty-state">
          <svg width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
          <h3>Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</h3>
          <p>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ø¹Ù…ÙŠÙ„ Ù„Ø¹Ø±Ø¶ ÙˆØ¥Ø¯Ø§Ø±Ø© Ù…Ø±Ø§Ø­Ù„Ù‡</p>
        </div>
      </main>
    </div>
  </div>
  
  <!-- Modal: Add Client -->
  <div id="addClientModal" class="modal-overlay" style="display:none">
    <div class="modal-box">
      <h3>â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h3>
      <input type="text" id="newClientName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" class="modal-input">
      <input type="text" id="newClientService" placeholder="Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©" class="modal-input">
      <div class="modal-actions">
        <button onclick="submitAddClient()" class="modal-btn primary">Ø­ÙØ¸</button>
        <button onclick="closeModal('addClientModal')" class="modal-btn">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>
  
  <script>
    let allClients = [];
    let currentClient = null;
    
    // Load clients on page load
    document.addEventListener('DOMContentLoaded', loadClients);
    
    // Search functionality
    document.getElementById('searchClients').addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase();
      const filtered = allClients.filter(c => 
        c.name.toLowerCase().includes(query) || c.code.toLowerCase().includes(query)
      );
      renderClientsList(filtered);
    });
    
    async function loadClients() {
      const list = document.getElementById('clientsList');
      try {
        const res = await fetch('/admin/api/clients');
        if (!res.ok) throw new Error('Failed to load');
        allClients = await res.json();
        renderClientsList(allClients);
      } catch (err) {
        list.innerHTML = '<p style="color:#ef4444;padding:20px">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</p>';
      }
    }
    
    function renderClientsList(clients) {
      const list = document.getElementById('clientsList');
      if (!clients.length) {
        list.innerHTML = '<p class="empty-state" style="padding:20px;text-align:center;color:#94a3b8">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡</p>';
        return;
      }
      
      list.innerHTML = clients.map(c => `
        <button class="client-item ${currentClient?.code === c.code ? 'active' : ''}" 
                onclick="loadClientDetails('${c.code}', '${c.name}')">
          <div style="font-weight:600;margin-bottom:4px">${c.name}</div>
          <div style="font-size:12px;opacity:.7">${c.code}</div>
        </button>
      `).join('');
    }
    
    async function loadClientDetails(code, name) {
      currentClient = { code, name };
      
      // Update active state
      document.querySelectorAll('.client-item').forEach(el => el.classList.remove('active'));
      event.target.closest('.client-item').classList.add('active');
      
      const panel = document.getElementById('mainContent');
      panel.innerHTML = '<div class="loading"><div class="spinner"></div><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>';
      
      try {
        const res = await fetch(`/admin/api/client/${code}/steps`);
        const steps = await res.json();
        
        const doneCount = steps.filter(s => s.done).length;
        const progress = Math.round((doneCount / steps.length) * 100);
        
        panel.innerHTML = `
          <div class="panel-header">
            <div>
              <h3 class="panel-title">${name}</h3>
              <p style="color:#64748b;margin:4px 0">ÙƒÙˆØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©: <strong>${code}</strong></p>
            </div>
          </div>
          
          <div class="stats-card">
            <h4>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</h4>
            <div class="number">${progress}%</div>
            <div style="font-size:14px;margin-top:4px">${doneCount} Ù…Ù† ${steps.length} Ù…Ø±Ø­Ù„Ø© Ù…ÙƒØªÙ…Ù„Ø©</div>
          </div>
          
          <div style="margin-bottom:12px">
            <h4 style="margin-bottom:12px">Ø§Ù„Ù…Ø±Ø§Ø­Ù„</h4>
          </div>
          
          <div id="stepsList">
            ${steps.map(s => `
              <div class="step-item ${s.done ? 'done' : ''}">
                <div>
                  <div style="font-weight:600;margin-bottom:4px">${s.name}</div>
                  <div style="font-size:12px;color:#64748b">${s.done ? 'âœ“ Ù…ÙƒØªÙ…Ù„Ø©' : 'â—‹ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±'}</div>
                </div>
                <div class="step-actions">
                  <button class="btn-sm btn-toggle" onclick="toggleStep('${code}', '${escapeHtml(s.name)}')">
                    ${s.done ? 'Ø¥Ù„ØºØ§Ø¡ âœ“' : 'ØªØ¹Ù„ÙŠÙ… âœ“'}
                  </button>
                  <button class="btn-sm btn-delete" onclick="deleteStep('${code}', '${escapeHtml(s.name)}')">
                    ğŸ—‘ï¸
                  </button>
                </div>
              </div>
            `).join('')}
          </div>
        `;
      } catch (err) {
        panel.innerHTML = '<p style="color:#ef4444;text-align:center;padding:40px">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</p>';
      }
    }
    
    async function toggleStep(code, stepName) {
      try {
        const res = await fetch(`/admin/api/client/${code}/toggle-step`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ step: stepName })
        });
        
        if (res.ok) {
          loadClientDetails(code, currentClient.name);
        }
      } catch (err) {
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£');
      }
    }
    
    async function deleteStep(code, stepName) {
      if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø±Ø­Ù„Ø© "${stepName}"ØŸ`)) return;
      
      try {
        const res = await fetch(`/admin/api/client/${code}/delete-step`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ step: stepName })
        });
        
        if (res.ok) {
          loadClientDetails(code, currentClient.name);
        }
      } catch (err) {
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù');
      }
    }
    
    function openAddClientModal() {
      document.getElementById('addClientModal').style.display = 'flex';
      document.getElementById('newClientName').value = '';
      document.getElementById('newClientService').value = '';
    }
    
    function closeModal(id) {
      document.getElementById(id).style.display = 'none';
    }
    
    async function submitAddClient() {
      const name = document.getElementById('newClientName').value.trim();
      const service = document.getElementById('newClientService').value.trim();
      
      if (!name) {
        alert('Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø·Ù„ÙˆØ¨');
        return;
      }
      
      try {
        const res = await fetch('/admin/api/add-client', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, service })
        });
        
        const data = await res.json();
        if (data.ok) {
          alert(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!\n\nÙƒÙˆØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©: ${data.code}`);
          closeModal('addClientModal');
          loadClients();
        }
      } catch (err) {
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£');
      }
    }
    
    function escapeHtml(text) {
      return text.replace(/'/g, "\\'").replace(/"/g, '&quot;');
    }
  </script>
  
  <style>
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1000}
    .modal-box{background:#fff;padding:28px;border-radius:14px;max-width:440px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.3)}
    .modal-box h3{margin:0 0 20px;font-size:20px}
    .modal-input{width:100%;padding:12px;border:1px solid #e0e7f1;border-radius:8px;margin-bottom:14px;font-size:15px}
    .modal-input:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.1)}
    .modal-actions{display:flex;gap:10px;margin-top:20px}
    .modal-btn{flex:1;padding:12px;border:none;border-radius:8px;font-weight:600;cursor:pointer}
    .modal-btn.primary{background:#3b82f6;color:#fff}
    .modal-btn.primary:hover{background:#2563eb}
    .modal-btn:not(.primary){background:#f1f5f9;color:#334155}
  </style>
</body>
</html>
