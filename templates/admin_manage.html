<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Admin Manage</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- ====== STYLE ====== -->
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, sans-serif;
      background: #f4f6f9;
      color: #333;
    }

    /* ====== Header ====== */
    header {
      background: linear-gradient(90deg, #1e88e5, #fb8c00);
      color: #fff;
      padding: 14px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      margin: 0;
      font-size: 18px;
    }

    header a {
      color: #fff;
      text-decoration: none;
      font-weight: bold;
    }

    /* ====== Layout ====== */
    .container {
      max-width: 1100px;
      margin: 20px auto;
      padding: 0 15px;
    }

    /* ====== Dropdown ====== */
    .select-box {
      position: relative;
      max-width: 400px;
      margin-bottom: 20px;
    }

    .select-display {
      background: #fff;
      border: 1px solid #ddd;
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }

    .dropdown {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      left: 0;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-top: 5px;
      z-index: 10;
      max-height: 260px;
      overflow-y: auto;
    }

    .dropdown.show {
      display: block;
    }

    .dropdown input {
      width: 100%;
      padding: 10px;
      border: none;
      border-bottom: 1px solid #eee;
      outline: none;
    }

    .client-option {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #f1f1f1;
    }

    .client-option:hover {
      background: #f0f7ff;
    }

    /* ====== Card ====== */
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      margin-top: 20px;
    }

    .card h2 {
      margin-top: 0;
      font-size: 18px;
    }

    /* ====== Steps ====== */
    .step-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }

    .step-row:last-child {
      border-bottom: none;
    }

    .admin-action {
      border: 1px solid #ccc;
      background: #fff;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 16px;
    }

    .admin-action.done {
      background: #1e88e5;
      color: #fff;
      border-color: #1e88e5;
    }

    /* ====== Buttons ====== */
    .actions {
      margin-top: 15px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .add-step-btn,
    .save-btn {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }

    .add-step-btn {
      background: #fb8c00;
      color: #fff;
    }

    .save-btn {
      background: #1e88e5;
      color: #fff;
    }

  </style>
</head>

<body>

<header>
  <h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h1>
  <a href="/admin/logout">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</a>
</header>

<div class="container">

  <!-- ====== Client Select ====== -->
  <div class="select-box">
    <div class="select-display" onclick="toggleDropdown()">
      Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„
    </div>

    <div class="dropdown" id="clientDropdown">
      <input type="text" placeholder="Ø¨Ø­Ø«..." onkeyup="filterClients(this.value)">
      <div id="clientList"></div>
    </div>
  </div>

  <!-- ====== Steps Card ====== -->
  <div class="card" id="stepsCard" style="display:none;">
    <h2 id="clientTitle"></h2>

    <div id="stepsList"></div>

    <div class="actions">
      <button class="add-step-btn" onclick="addStep()">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø­Ù„Ø©</button>
      <button class="save-btn" onclick="saveChanges()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
    </div>
  </div>

</div>

<!-- ====== SCRIPT ====== -->
<script>
let clientsCache = {};
let currentCode = null;
let pending = {};
let lastSteps = [];

/* ---------- Dropdown ---------- */
function toggleDropdown(){
  document.getElementById("clientDropdown").classList.toggle("show");
}

/* ---------- Load Clients ---------- */
fetch("/admin/api/clients")
.then(r=>r.json())
.then(data=>{
  let list = document.getElementById("clientList");
  list.innerHTML = "";
  data.forEach(c=>{
    clientsCache[c.code] = c;
    let d = document.createElement("div");
    d.className = "client-option";
    d.innerText = `${c.name} (${c.code})`;
    d.onclick = ()=>selectClient(c.code);
    list.appendChild(d);
  });
});

function filterClients(q){
  q = q.toLowerCase();
  document.querySelectorAll(".client-option").forEach(el=>{
    el.style.display = el.innerText.toLowerCase().includes(q) ? "" : "none";
  });
}

/* ---------- Select Client ---------- */
function selectClient(code){
  currentCode = code;
  pending = {};
  document.querySelector(".select-display").innerText =
    clientsCache[code].name + " â€” " + clientsCache[code].service;
  document.getElementById("clientDropdown").classList.remove("show");
  loadChecklist(code);
}

/* ---------- Load All Steps ---------- */
function loadChecklist(code){
  fetch(`/admin/api/client/${code}/all-steps`)
  .then(r=>r.json())
  .then(steps=>{
    lastSteps = steps;
    document.getElementById("stepsCard").style.display = "block";
    document.getElementById("clientTitle").innerText =
      "Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„ ("+code+")";

    let box = document.getElementById("stepsList");
    box.innerHTML = "";

    steps.forEach(s=>{
      let current = (s.name in pending) ? pending[s.name] : s.done;

      let row = document.createElement("div");
      row.className = "step-row";
      row.innerHTML = `
        <span>${s.name}</span>
        <button class="admin-action ${current?'done':''}"
          onclick="toggleLocal('${s.name}', ${current})">
          ${current?'âœ”':'â—‹'}
        </button>
      `;
      box.appendChild(row);
    });
  });
}

/* ---------- Toggle (Local Only) ---------- */
function toggleLocal(step, current){
  pending[step] = !current;
  loadChecklist(currentCode);
}

/* ---------- Save ---------- */
function saveChanges(){
  fetch(`/admin/api/client/${currentCode}/save-steps`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({steps: pending})
  })
  .then(r=>r.json())
  .then(()=>{
    pending = {};
    loadChecklist(currentCode);
    alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…");
  });
}

/* ---------- Add Step (Global) ---------- */
function addStep(){
  let step = prompt("Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:");
  if(!step) return;

  fetch("/admin/api/add-step",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({step: step})
  })
  .then(()=>loadChecklist(currentCode));
}
</script>

</body>
</html>

