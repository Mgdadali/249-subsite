<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<div class="container" style="max-width:1000px">
  <h2>ðŸ“‹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ù…Ø±Ø§Ø­Ù„</h2>

  <!-- Select Client -->
  <div class="select-box">
    <div class="select-display" onclick="toggleDropdown()">Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„</div>

    <div class="select-dropdown" id="clientDropdown">
      <input type="text" placeholder="Ø¨Ø­Ø«..." onkeyup="filterClients(this.value)">
      <div id="clientList"></div>
    </div>
  </div>

  <!-- Checklist -->
  <div id="stepsCard" class="steps-card" style="display:none">
    <h3 id="clientTitle"></h3>
    <div id="stepsList"></div>
  </div>
</div>

<script>
let clientsCache = {};
let currentCode = null;

/* ================= Load Clients ================= */
fetch("/admin/api/clients")
  .then(r => r.json())
  .then(data => {
    let list = document.getElementById("clientList");
    list.innerHTML = "";
    data.forEach(c => {
      clientsCache[c.code] = c;
      let div = document.createElement("div");
      div.className = "client-option";
      div.innerText = `${c.name} (${c.code})`;
      div.onclick = () => selectClient(c.code);
      list.appendChild(div);
    });
  });

/* ================= Dropdown ================= */
function toggleDropdown(){
  document.getElementById("clientDropdown").classList.toggle("show");
}

function filterClients(val){
  document.querySelectorAll(".client-option").forEach(el=>{
    el.style.display = el.innerText.toLowerCase().includes(val.toLowerCase())
      ? "block" : "none";
  });
}

/* ================= Select Client ================= */
function selectClient(code){
  currentCode = code;
  document.querySelector(".select-display").innerText =
    clientsCache[code].name + " â€” " + clientsCache[code].service;

  document.getElementById("clientDropdown").classList.remove("show");
  loadChecklist(code);
}

/* ================= Load Checklist ================= */
function loadChecklist(code){
  fetch(`/admin/api/client/${code}/checklist`)
    .then(r => r.json())
    .then(data => {
      document.getElementById("stepsCard").style.display = "block";
      document.getElementById("clientTitle").innerText =
        "Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„ (" + code + ")";

      let box = document.getElementById("stepsList");
      box.innerHTML = "";

      if(data.steps.length === 0){
        box.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±Ø§Ø­Ù„ Ø¨Ø¹Ø¯</p>";
        return;
      }

      data.steps.forEach(s=>{
        let row = document.createElement("div");
        row.className = "step-row";

        row.innerHTML = `
          <span>${s.name}</span>
          <div>
            <button class="admin-action ${s.done?'done':''}"
              onclick="toggleStep('${s.name}')">
              ${s.done?'âœ”':'â—‹'}
            </button>
            <button class="admin-action danger"
              onclick="deleteStep('${s.name}')">
              âœ–
            </button>
          </div>
        `;
        box.appendChild(row);
      });
    });
}

/* ================= Toggle Step ================= */
function toggleStep(step){
  fetch(`/admin/api/client/${currentCode}/toggle-step`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({step})
  }).then(()=>loadChecklist(currentCode));
}

/* ================= Delete Step ================= */
function deleteStep(step){
  if(!confirm("Ø­Ø°Ù Ø§Ù„Ù…Ø±Ø­Ù„Ø©ØŸ")) return;
  fetch(`/admin/api/client/${currentCode}/delete-step`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({step})
  }).then(()=>loadChecklist(currentCode));
}
</script>

</body>
</html>
