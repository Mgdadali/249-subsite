<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>249 | حالة الطلب</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <style>
    /* ===== Progress Bar ===== */
    .progress-bar-outer{
      background:#e6eef8;
      border-radius:999px;
      height:14px;
      width:100%;
      overflow:hidden;
    }

    .progress-bar-inner{
      height:100%;
      width:0%;
      border-radius:999px;
      background:linear-gradient(
        120deg,
        #1e90ff 0%,
        #64b5f6 45%,
        #ffffff 50%,
        #64b5f6 55%,
        #1e90ff 100%
      );
      background-size:300% 100%;
      animation:progressShine 2.5s linear infinite;
      transition:width .6s ease;
    }

    @keyframes progressShine{
      from{background-position:0% 0}
      to{background-position:300% 0}
    }

    .progress-circle{
      width:80px;height:80px;border-radius:50%;
      background:#f4f6f9;
      display:flex;align-items:center;justify-content:center;
      font-weight:bold;
      box-shadow:0 2px 8px rgba(0,0,0,.1);
    }

    /* ===== Checklist Icons ===== */
    .check-icon{
      width:24px;height:24px;
      border-radius:6px;
      background:linear-gradient(135deg,#22c55e,#16a34a);
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 4px 10px rgba(0,0,0,.25);
    }
    .check-icon::after{
      content:"✔";
      color:#fff;
      font-size:13px;
      font-weight:bold;
    }

    .spinner{
      width:22px;height:22px;
      border:3px solid #cfe3ff;
      border-top-color:#1e90ff;
      border-radius:50%;
      animation:spin 1s linear infinite;
    }
    @keyframes spin{
      to{transform:rotate(360deg)}
    }
  </style>
</head>

<body class="page-checklist">
<div class="container">
  <a class="back-link" href="/">◀ الرجوع</a>

  <header class="client-header">
    <img src="https://i.ibb.co/7JN5w2K3/logo-removebg-preview-1.png" class="logo-sm">
    <div class="client-info">
      <h2 id="clientName">جاري التحميل...</h2>
      <p id="clientService" class="muted"></p>
    </div>
  </header>

  <section class="progress-section">
    <div class="progress-left">
      <div class="progress-circle"><span id="progressPct">0%</span></div>
    </div>
    <div class="progress-right">
      <div class="progress-bar-outer">
        <div class="progress-bar-inner" id="progressBar"></div>
      </div>
      <p id="progressText" class="muted"></p>
    </div>
  </section>

  <section class="checklist-section">
    <h3>مراحل الطلب</h3>
    <ul id="checklistList" class="checklist-list"></ul>
  </section>

  <section class="notes-section">
    <p id="notes" class="muted"></p>
  </section>
</div>

<script>
const TRACK_CODE = "{{ code }}";

window.addEventListener('DOMContentLoaded',()=>{
  if(TRACK_CODE) renderClientChecklist(TRACK_CODE);
});

function updateProgressBar(pct){
  document.getElementById('progressBar').style.width = pct+'%';
  document.getElementById('progressPct').innerText = pct+'%';
}

async function renderClientChecklist(code){
  const nameEl = document.getElementById('clientName');
  const serviceEl = document.getElementById('clientService');
  const listEl = document.getElementById('checklistList');
  const textEl = document.getElementById('progressText');
  const notesEl = document.getElementById('notes');

  try{
    const res = await fetch(`/track?code=${encodeURIComponent(code)}`);
    const data = await res.json();

    nameEl.textContent = data.name || 'عميل';
    serviceEl.textContent = data.service ? `الخدمة: ${data.service}` : '';

    let completed = 0;
    listEl.innerHTML = '';

    data.checklist.forEach((s,idx)=>{
      if(s.done) completed++;

      listEl.innerHTML += `
        <li class="${s.done?'done':''}">
          <div class="step-left">
            <div class="step-badge">${idx+1}</div>
            <strong>${s.name}</strong>
          </div>
          <div class="step-right">
            ${s.done ? '<span class="check-icon"></span>' : '<span class="spinner"></span>'}
          </div>
        </li>`;
    });

    const pct = Math.round((completed/data.checklist.length)*100);
    updateProgressBar(pct);
    textEl.textContent = `تم إتمام ${completed} من ${data.checklist.length} مرحلة (${pct}%)`;

    if(data.last_update) notesEl.textContent = `آخر تحديث: ${data.last_update}`;
  }catch(e){
    nameEl.textContent = 'خطأ في الاتصال';
    console.error(e);
  }
}
</script>
</body>
</html>
