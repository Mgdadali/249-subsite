<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>249 | حالة الطلب</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    /* ====== Shiny Progress Bar Animation ====== */
    .progress-bar-outer {
      background: #e0e0e0;
      border-radius: 12px;
      height: 20px;
      width: 100%;
      overflow: hidden;
    }

    .progress-bar-inner {
      height: 100%;
      width: 0%;
      background: linear-gradient(
        270deg,
        #1e88e5,
        #42a5f5,
        #1e88e5
      );
      background-size: 400% 100%;
      border-radius: 12px;
      transition: width 0.5s ease;
      animation: progressShine 2s linear infinite;
    }

    @keyframes progressShine {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    .progress-circle {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: #f4f6f9;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 16px;
      margin: auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body class="page-checklist">
  <div class="container">
    <a class="back-link" href="/"><span>◀</span> الرجوع</a>

    <header class="client-header">
      <img src="https://i.ibb.co/7JN5w2K3/logo-removebg-preview-1.png" alt="249" class="logo-sm">
      <div class="client-info">
        <h2 id="clientName">جاري التحميل...</h2>
        <p id="clientService" class="muted"></p>
      </div>
    </header>

    <section class="progress-section">
      <div class="progress-left">
        <div class="progress-circle" id="progressCircle"><span id="progressPct">0%</span></div>
      </div>
      <div class="progress-right">
        <div class="progress-bar-outer">
          <div class="progress-bar-inner" id="progressBar"></div>
        </div>
        <p id="progressText" class="muted">جاري حساب نسبة الإنجاز...</p>
      </div>
    </section>

    <section class="checklist-section">
      <h3>مراحل الطلب</h3>
      <ul id="checklistList" class="checklist-list"></ul>
    </section>

    <section class="notes-section">
      <p id="notes" class="muted"></p>
    </section>
  </div>

  <script src="{{ url_for('static', filename='script.js') }}"></script>
  <script>
    const TRACK_CODE = "{{ code }}";

    window.addEventListener('DOMContentLoaded', () => {
      if (!TRACK_CODE) {
        document.getElementById('clientName').innerText = 'لا يوجد كود متاح';
        return;
      }
      renderClientChecklist(TRACK_CODE);
    });

    // ====== تحديث شريط التقدم مع حركة لمعة ======
    function updateProgressBar(pct) {
      const bar = document.getElementById('progressBar');
      const pctText = document.getElementById('progressPct');
      bar.style.width = pct + '%';
      pctText.innerText = pct + '%';
      
      // لو 100% خلي اللون أخضر ثابت، وإلا خلي لمعة
      if (pct === 100) {
        bar.style.background = 'linear-gradient(90deg,#28a745,#1db954)';
        bar.style.animation = 'none';
      } else {
        bar.style.background = 'linear-gradient(270deg, #1e88e5, #42a5f5, #1e88e5)';
        bar.style.animation = 'progressShine 2s linear infinite';
      }
    }

    async function renderClientChecklist(code){
      const nameEl = document.getElementById('clientName');
      const serviceEl = document.getElementById('clientService');
      const listEl = document.getElementById('checklistList');
      const pctEl = document.getElementById('progressPct');
      const barEl = document.getElementById('progressBar');
      const textEl = document.getElementById('progressText');
      const notesEl = document.getElementById('notes');

      nameEl.textContent = 'جاري التحميل...';
      serviceEl.textContent = '';
      listEl.innerHTML = '';
      notesEl.textContent = '';

      try {
        const res = await fetch(`/track?code=${encodeURIComponent(code)}`);
        const data = await res.json();
        if(data.error){
          nameEl.textContent = data.error;
          return;
        }

        nameEl.textContent = data.name || 'عميل';
        serviceEl.textContent = data.service ? `الخدمة: ${data.service}` : '';

        const steps = data.checklist || [];
        let completed = 0;
        listEl.innerHTML = '';
        steps.forEach((s, idx) => {
          const li = document.createElement('li');
          li.className = s.done ? 'done' : 'pending';
          li.innerHTML = `
  <div class="step-left">
    <div class="step-badge">${idx + 1}</div>
    <div class="step-text">
      <strong>${s.name}</strong>
    </div>
  </div>

  <div class="step-right">
    ${
      s.done
        ? '<span class="check-icon"></span>'
        : '<span class="spinner"></span>'
    }
  </div>
`;




          `;
          listEl.appendChild(li);
          if (s.done) completed++;
        });

        const percent = steps.length ? Math.round((completed / steps.length) * 100) : 0;
        updateProgressBar(percent);

        textEl.textContent = `تم إتمام ${completed} من ${steps.length} مرحلة (${percent}%)`;

        if (data.last_update) notesEl.textContent = `آخر تحديث: ${data.last_update}`;
        if (data.notes) {
          notesEl.textContent += (notesEl.textContent ? ' — ' : '') + `ملاحظة: ${data.notes}`;
        }

      } catch (err) {
        nameEl.textContent = 'حدث خطأ في الاتصال بالخادم';
        console.error(err);
      }
    }

    window.renderClientChecklist = renderClientChecklist;
  </script>
</body>
</html>
